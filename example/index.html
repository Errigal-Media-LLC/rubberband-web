<html>
<body>

<button id="osc" onclick="osc()">Use Oscillator</button>
<button id="mic" onclick="mic()">Use Mic</button>

<br/>

<label for="pitch">Pitch</label>
<input id="pitch" onchange="handlePitch(this.value)" type="range" min="0.4" step="0.2"
       max="1.6" value="1.0" disabled="disabled"/>

<br/>

<label for="tempo">Tempo</label>
<input id="tempo" onchange="handleTempo(this.value)" type="range" min="0.4" step="0.2"
       max="1.6" value="1.0" disabled="disabled"/>

<script>
    var audioContext;
    var processor;

    async function start() {
        audioContext = new AudioContext();
        await audioContext.resume();
        document.getElementById("osc").remove();
        document.getElementById("mic").remove();
        document.getElementById("pitch").removeAttribute("disabled");
        document.getElementById("tempo").removeAttribute("disabled");

        // Load rubberband processor
        await audioContext.audioWorklet.addModule("../dist/rubberband-processor.js");
        processor = new AudioWorkletNode(audioContext, "rubberband-processor");
    }

    async function osc() {
        await start();

        // Create source (oscillator)
        const source = new OscillatorNode(audioContext, {
            frequency: 380,
            type: 'sine',
        });

        // Connect nodes
        source.connect(processor);
        processor.connect(audioContext.destination);

        // Start everything
        source.start();
    }

    async function mic() {
        await start();

        // Create source (oscillator)
        const stream = await navigator.mediaDevices
            .getUserMedia({
                audio: true,
                video: false,
            });

        const source = new MediaStreamAudioSourceNode(audioContext, {
            mediaStream: stream,
        });

        // Connect nodes
        source.connect(processor);
        processor.connect(audioContext.destination);

        // Start everything
        source.start();
    }

    function handlePitch(value) {
        if (processor) {
            processor.port.postMessage(JSON.stringify(["pitch", value]));
        }
    }

    function handleTempo(value) {
        if (processor) {
            processor.port.postMessage(JSON.stringify(["tempo", value]));
        }
    }
</script>
</body>
</html>